### 第15章 外中断 
#### 15.1 接口芯片和端口 
    CPU 通过端口和外部设备进行联系 
#### 15.2 外中断信息 
    当CPU外部有需要处理的事情发生时,相关芯片将向CPU发出相应的中断信息。CPU在执行完当前指令后,可以检测到发送过来的中断信息,
    引发中断过程，处理外设的输入。
    1> 可屏蔽中断 
       CPU是否响应可屏蔽中断，要看标志寄存器IF的设置。当检测到可屏蔽中断信息时，如果IF=1,则CPU在执行完当前指令后响应中断,
       引发中断过程,如果IF = 0,则不响应可屏蔽中断.
       sti 设置IF = 1 
       cli 设置IF = 0 
    2> 不可屏蔽中断
       当CPU检测到不可屏蔽中断信息时,则在执行完当前指令后，立即响应,引发中断过程。
       对于8086CPU，不可屏蔽中断的中断类型码固定为2.

#### PC机键盘的处理过程 
    1> 键盘输入
    按下一个键产生的扫描码为通码, 松开一个键产生的扫描码为断码。 
    断码 = 通码 + 80h 
    2> 引发9号中断
       键盘的输入到达 60h 端口时,相关的芯片就会向CPU发出中断类型码为9的可屏蔽中断信息。
    3> 执行int 9 中断例程
        读出 60h 端口中的扫描码
        如果是字符键的扫描码，将该扫描码和对应的字符码(ASCII码)送入内存中的BIOS键盘缓冲区;
        如果是控制键或切换键的扫描码,则将其转变为状态字节(用二进制记录控制键和切换键的字节)
        写入内存中存储状态字节的单元
        对键盘系统进行相关的控制
        0040:17 单元存储键盘状态字节

#### 15.4 编写 int 9中断例程
    assume cs:code 
    stack segment
        db 128 dup (0)
    stack ends 

    data segment 
        dw 0,0 
    data ends 

    code segment 
    start   mov ax,stack 
            mov ss,ax 
            mov sp,128 

            mov ax,data 
            mov ds,ax 

            mov ax,0 
            mov es,ax 

            push es:[9*4]
            pop  ds:[0]
            push es:[9*4]
            pop  ds:[2]     ;将原来的int 9中断例程的入口地址保存在ds:0、ds:2单元中 
            
            mov word ptr es:[9*4], offset int 9 
            mov es:[9*4+2], cs 

            mov ax,0b800h 
            mov es,ax 
            mov ah,'a'

        s:  mov es:[160*12 + 40 * 2],ah 
            call delay 
            inc ah 
            cmp ah,'z'
            jna s 

            mov ax,0 
            mov es,ax 
            push ds:[0]
            pop es:[9*4]
            push ds:[2]
            pop es:[9*4+2]

            mov ax,4c00h 
            int 21h 
    delay:  push ax 
            push dx 
            mov dx,1000h 
            mov ax,0 
       s1:  sub ax,1 
            sbb dx,0 
            cmp ax,0 
            jne s1 
            cmp dx,0 
            jne s1 
            pop dx 
            pop ax 
            ret 
    ;; 新的int 9中断例程 
    int 9: push ax 
           push bx 
           push es 

           in al, 60h 

           pushf 
           pushf 
           pop bx 
           and bh 11111100b 
           push bx 
           popf 
           call dword ptr ds:[0]

           cmp al,1 
           jne int9ret 

           mov ax,0b800h 
           mov es,ax 
           inc byte ptr es:[160*12 + 40 * 2 + 1]
    int9ret: pop es 
             pop bx 
             pop ax 
             iret 
    code ends 
    end start 

##### 15.5 安装新的int 9中断例程
